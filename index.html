<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PASSE TEMPS VEGA ‚Äî v1.7</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  /* Jaune / ocre lisible (textes sombres) */
  --bg:#FFF8DC; --card:#FFEFB3; --elev:#FFE082; --border:#D8B84A;
  --text:#1F2937; --muted:#4B5563;
  --btn:#D97706; --btnH:#B45309;
  --danger:#B91C1C;
  --radius:14px; --shadow:0 6px 16px rgba(0,0,0,.12), inset 0 1px 0 rgba(255,255,255,.3);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}

/* Header */
header{display:flex;align-items:center;gap:12px;padding:12px;border-bottom:1px solid var(--border);background:var(--card);position:sticky;top:0;z-index:10}
.logo{width:50px;height:50px;min-width:50px;min-height:50px;border-radius:12px;border:1px solid var(--border);background:#fff;display:grid;place-items:center;overflow:hidden;flex-shrink:0}
.logo img{width:100%;height:100%;object-fit:cover}
.brand h1{margin:0;font-size:18px;color:var(--text)}
.badge{display:inline-block;margin-left:8px;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;color:#7c2d12;background:#ffedd5;border:1px solid #fdba74}
.tabs{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
.tab{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;color:var(--text);font-weight:700}
.tab.active{background:linear-gradient(180deg,#FACC15,#F59E0B);color:#111;border-color:transparent}
a.link{color:#7c2d12;text-decoration:underline;cursor:pointer;margin-left:10px}

/* Layout & components */
main{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
h2{margin:0 0 10px;font-size:20px}
h3{margin:10px 0 6px;font-size:16px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
input,select,textarea,button{width:100%;padding:11px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text)}
input:focus,select:focus,textarea:focus{outline:none;border-color:#F59E0B;box-shadow:0 0 0 3px rgba(245,158,11,.25)}
button{cursor:pointer;background:var(--btn);color:#fff;font-weight:800;border:none}
button:hover{background:var(--btnH)}
button.secondary{background:#fff;color:#111;border:1px solid var(--border)}
button.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
.grid{display:grid;gap:12px}
.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:980px){.cols-2,.cols-3{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left}
.table thead th{background:var(--elev);font-size:12px;color:#374151}

/* KPI */
.kpi{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
.kpi .item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
.kpi .item h3{margin:0;color:#6b7280;font-size:12px}
.kpi .item div{margin-top:6px;font-size:22px;font-weight:800}

/* Gift icon (blink) */
.gift{display:inline-flex;align-items:center;gap:6px}
.gift i{display:inline-block}
@keyframes blink{0%,60%,100%{opacity:1}30%{opacity:.15}}
.gift .icon{animation:blink 1.2s infinite}
.gift .icon::after{content:"üéÅ"}

/* Chips lettres */
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:999px;font-weight:700;cursor:pointer}
.chip.active{background:#fef3c7;border-color:#f59e0b}

/* Stocks */
.stock-low{color:var(--danger);font-weight:800}
small.muted{color:var(--muted)}
hr.sep{border:0;border-top:1px dashed var(--border);margin:10px 0}
footer{padding:14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;background:var(--card);color:#374151}

/* Popup changelog */
#versionPopup{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
#versionPopup .box{background:#fff;border-radius:12px;max-width:700px;width:92%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.4);max-height:90%;overflow:auto}
#versionPopup h2{margin-top:0}
#versionPopup ul{margin:0 0 10px 18px}
</style>
</head>
<body>
<header>
  <div class="logo" title="Logo"><img id="logoImg" alt="Logo PASSE TEMPS VEGA"></div>
  <div class="brand"><h1>PASSE TEMPS VEGA <span class="badge" id="verBadge">v1.7</span><a class="link" id="btnShowWhatsNew">Nouveaut√©s</a></h1></div>
  <nav class="tabs">
    <button class="tab active" data-tab="dash">Dashboard</button>
    <button class="tab" data-tab="clients">Clients</button>
    <button class="tab" data-tab="produits">Produits</button>
    <button class="tab" data-tab="ventes">Ventes</button>
    <button class="tab" data-tab="param">Param√®tres</button>
  </nav>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="dash" class="card">
    <h2>Vue d‚Äôensemble</h2>
    <div class="kpi">
      <div class="item"><h3>Clients actifs (90j)</h3><div id="kpiActifs">0</div></div>
      <div class="item"><h3>Top produits (Qt√©)</h3><div id="kpiTopProd">‚Äî</div></div>
      <div class="item"><h3>Top clients (Achats)</h3><div id="kpiTopCli">‚Äî</div></div>
    </div>
    <hr class="sep">
    <div class="grid cols-2">
      <div>
        <h3>Top produits</h3>
        <table class="table" id="tblTopProd"><thead><tr><th>Produit</th><th>Qt√©</th></tr></thead><tbody></tbody></table>
      </div>
      <div>
        <h3>Top clients</h3>
        <table class="table" id="tblTopCli"><thead><tr><th>Client</th><th>Achats</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <hr class="sep">
    <h3>Anniversaires <small class="muted">(dans 30 jours)</small></h3>
    <table class="table" id="tblBirthSoon"><thead><tr><th>Client</th><th>Animal</th><th>Jours</th></tr></thead><tbody></tbody></table>
  </section>

  <!-- CLIENTS -->
  <section id="clients" class="card" hidden>
    <h2>Clients</h2>
    <div class="grid cols-2">
      <div>
        <h3>Ajouter / √âditer</h3>
        <div class="grid cols-2">
          <div><label>Nom & pr√©nom</label><input id="c_nom" placeholder="Nom Pr√©nom (optionnel)"></div>
          <div><label>T√©l√©phone (BE, optionnel)</label><input id="c_tel" inputmode="numeric" maxlength="10" placeholder="0470123456"></div>
          <div><label>Email (optionnel)</label><input id="c_email" placeholder="a@b.be"></div>
          <div><label>Adresse (optionnelle)</label><input id="c_addr" placeholder="Rue, CP Ville"></div>
        </div>
        <hr class="sep">
        <h3>Animaux</h3>
        <div id="petsContainer" class="grid" style="gap:10px"></div>
        <button class="secondary" id="btnAddPet">+ Ajouter un animal</button>
        <div class="grid cols-3" style="margin-top:10px">
          <button id="btnSaveClient">Enregistrer</button>
          <button class="secondary" id="btnNewClient">Nouveau</button>
          <button class="ghost" id="btnDeleteClient" disabled>Supprimer</button>
        </div>
      </div>

      <div>
        <h3>Liste</h3>
        <input id="searchClient" placeholder="Recherche nom / email / tel / animal / race‚Ä¶">
        <table class="table" id="tblClients">
          <thead><tr><th>Propri√©taire</th><th>Animaux</th><th>T√©l</th><th>Email</th></tr></thead><tbody></tbody>
        </table>
        <aside style="margin-top:10px">
          <h3>Statistiques</h3>
          <div id="cliStats">S√©lectionnez un client‚Ä¶</div>
        </aside>
      </div>
    </div>
  </section>

  <!-- PRODUITS -->
  <section id="produits" class="card" hidden>
    <h2>Produits (liste unique)</h2>
    <div class="grid cols-2">
      <div>
        <h3>Ajouter / √âditer</h3>
        <div class="grid cols-3">
          <div style="grid-column:1/-1"><label>Nom du produit</label><input id="p_nom" placeholder="ex. M√©daille grav√©e"></div>
          <div><label>Stock</label><input id="p_stock" type="number" value="0"></div>
          <div><label>Stock minimum</label><input id="p_min" type="number" value="0"></div>
          <input type="hidden" id="p_id">
        </div>
        <div class="grid cols-3" style="margin-top:10px">
          <button id="btnSaveProduct">Enregistrer</button>
          <button class="secondary" id="btnNewProduct">Nouveau</button>
          <button class="ghost" id="btnDeleteProduct" disabled>Supprimer</button>
        </div>
      </div>

      <div>
        <h3>Catalogue</h3>
        <div class="chips" id="alphaChips"></div>
        <input id="searchProduit" placeholder="Recherche produit‚Ä¶ (nom)">
        <table class="table" id="tblProduits">
          <thead><tr><th>Produit</th><th>Stock</th><th>Min</th><th>Statut</th></tr></thead><tbody></tbody>
        </table>
        <small class="muted">Tri A‚ÜíZ. Filtre par lettre/chiffre via les puces.</small>
      </div>
    </div>
  </section>

  <!-- VENTES -->
  <section id="ventes" class="card" hidden>
    <h2>Enregistrer une vente (simple)</h2>
    <div class="grid cols-3">
      <div>
        <label>Client (facultatif)</label>
        <select id="v_client"></select>
      </div>
      <div style="grid-column:1/-1">
        <div id="v_client_info" class="gift" style="display:none"><i class="icon"></i><span id="v_client_animals"></span></div>
      </div>
      <div style="grid-column:1/-1"><label>Produit</label><select id="v_prod"></select></div>
      <div><label>Quantit√©</label><input id="v_qty" type="number" value="1" min="1"></div>
    </div>
    <div class="grid cols-2" style="margin-top:10px">
      <button id="btnSaveSale">Valider vente</button>
      <button class="secondary" id="btnCancelSale">Annuler</button>
    </div>
  </section>

  <!-- PARAM√àTRES -->
  <section id="param" class="card" hidden>
    <h2>Param√®tres</h2>
    <div class="grid cols-2">
      <div>
        <h3>Logo</h3>
        <div class="grid cols-3">
          <div style="grid-column:1/-1;display:flex;gap:10px;align-items:center">
            <div class="logo" style="width:56px;height:56px"><img id="logoPreview" alt="Aper√ßu"></div>
            <input type="file" id="logoFile" accept="image/*">
          </div>
          <button class="secondary" id="btnSaveLogo">Enregistrer le logo</button>
          <button class="ghost" id="btnClearLogo">Supprimer logo</button>
        </div>
        <small class="muted">Le logo est stock√© localement dans le navigateur.</small>
      </div>

      <div>
        <h3>Listes de races</h3>
        <div class="grid cols-2">
          <div>
            <label>Races de chiens</label>
            <div id="editBreedsDog" class="chips"></div>
            <button class="secondary" data-add="breedsDog">+ Ajouter</button>
          </div>
          <div>
            <label>Races de chats</label>
            <div id="editBreedsCat" class="chips"></div>
            <button class="secondary" data-add="breedsCat">+ Ajouter</button>
          </div>
        </div>
        <small class="muted">Tri A‚ÜíZ automatique apr√®s ajout/√©dition.</small>
      </div>

      <div>
        <h3>Sauvegarde / Restauration</h3>
        <div class="grid cols-3">
          <button id="btnExportTxt" class="secondary">T√©l√©charger sauvegarde (.txt)</button>
          <label class="secondary" style="display:flex;align-items:center;justify-content:center;gap:8px;cursor:pointer">
            <input type="file" id="fileImport" accept=".txt,text/plain,application/json" style="display:none">
            Importer depuis un fichier .txt
          </label>
          <button id="btnExportJSON" class="ghost">Afficher JSON</button>
        </div>
        <pre id="exportArea" style="max-height:220px;overflow:auto;background:#fff;border:1px solid var(--border);padding:8px;border-radius:8px;margin-top:8px"></pre>
      </div>

      <div>
        <h3>Historique des versions</h3>
        <div id="changelog"></div>
        <button id="btnShowPopup" class="secondary" style="margin-top:8px">Relire les nouveaut√©s</button>
      </div>
    </div>
    <hr class="sep">
    <div>¬© PASSE TEMPS VEGA ‚Äî v1.7 ‚Ä¢ ¬© Pierre Charlier 2025 ‚Ä¢ Donn√©es locales (aucun serveur)</div>
  </section>
</main>

<footer>
  <div>¬© PASSE TEMPS VEGA ‚Äî v1.7 ‚Ä¢ ¬© Pierre Charlier 2025</div>
  <div><small class="muted">Jaune/ocre lisible ‚Ä¢ Sauvegarde .txt ‚Ä¢ Logo int√©gr√©</small></div>
</footer>

<!-- Popup changelog -->
<div id="versionPopup">
  <div class="box">
    <h2 id="popupTitle"></h2>
    <div id="popupContent"></div>
    <button class="secondary" onclick="document.getElementById('versionPopup').style.display='none'">Fermer</button>
  </div>
</div>

<script>
/* ================== Version & Changelog ================== */
const APP_VERSION="v1.7";
const STORAGE_VERSION_SEEN="ptv_version_seen";
const CHANGELOG={
  "v1.5":[
    "Fid√©lit√© 5+1",
    "Multi-animaux par client",
    "Anniversaire rouge J-7"
  ],
  "v1.6":[
    "Listes de races √©ditables",
    "Am√©liorations fid√®les + correctifs",
    "Export / Import JSON (copier/coller)",
    "Notification de nouvelle version"
  ],
  "v1.7":[
    "Palette jaune/ocre lisible (textes sombres)",
    "Logo carr√© fixe + logo int√©gr√© par d√©faut",
    "Sauvegarde et restauration via fichier .txt",
    "Dashboard : clients actifs, top produits/clients, anniversaires J-30 (üéÅ clignotant)",
    "Clients/Animaux simplifi√©s ; Produits = liste unique ; Ventes sans prix/remise/fid√©lit√©",
    "Recherche par nom/race/mail/tel ; filtre produits par initiale",
    "Suppression produit interdite s'il a d√©j√† √©t√© vendu (pas d'archivage)"
  ]
};
function renderChangelog(){
  let html="";
  const entries=Object.entries(CHANGELOG).sort((a,b)=>a[0]<b[0]?1:-1);
  for(const [ver,items] of entries){
    html+=`<h4 style="margin:8px 0">${ver}</h4><ul>`+items.map(i=>`<li>${i}</li>`).join("")+"</ul>";
  }
  document.getElementById("changelog").innerHTML=html;
}
function showVersionPopup(force=false){
  const seen=localStorage.getItem(STORAGE_VERSION_SEEN);
  if(force || seen!==APP_VERSION){
    document.getElementById("popupTitle").textContent="Nouveaut√©s "+APP_VERSION;
    document.getElementById("popupContent").innerHTML="<ul>"+CHANGELOG[APP_VERSION].map(i=>"<li>"+i+"</li>").join("")+"</ul>";
    document.getElementById("versionPopup").style.display="flex";
    localStorage.setItem(STORAGE_VERSION_SEEN,APP_VERSION);
  }
}
document.getElementById("btnShowWhatsNew").onclick=()=>showVersionPopup(true);
document.getElementById("btnShowPopup").onclick=()=>showVersionPopup(true);

/* ================== Donn√©es & helpers ================== */
const DBKEY='ptv_simple_v17_txt';
const LOGO_KEY='ptv_logo_dataurl_v2';

const DEFAULT_DOGS=["Barbet","Beagle","Berger Allemand","Berger Australien","Border Collie","Boxer","Bouledogue Fran√ßais","Cavalier King Charles","Chihuahua","Cocker","Dalmatien","Golden Retriever","Husky","Jack Russell","Labrador","Rottweiler","Shiba Inu","Shih Tzu","Teckel","Yorkshire Terrier"].sort((a,b)=>a.localeCompare(b,'fr'));
const DEFAULT_CATS=["Abyssin","Bengal","Birman","Bleu Russe","British Shorthair","Chartreux","Europ√©en (DSH)","Maine Coon","Norv√©gien","Persan","Ragdoll","Siamois","Sphynx"].sort((a,b)=>a.localeCompare(b,'fr'));

function days(n){return n*24*3600*1000}
function el(t,a={},c=[]){const n=document.createElement(t);for(const k in a){(k==='class')?n.className=a[k]:n.setAttribute(k,a[k])}c.forEach(x=>n.append(typeof x==='string'?document.createTextNode(x):x));return n;}
function toast(m){alert(m)}

function loadDB(){
  const raw=localStorage.getItem(DBKEY);
  if(raw){ try{return JSON.parse(raw)}catch(e){} }
  return {
    clients:[],
    produits:[],   // {id, nom, stock, min}
    ventes:[],     // {id,date,clientId?, lignes:[{productId,qty}]}
    lists:{breedsDog:[...DEFAULT_DOGS],breedsCat:[...DEFAULT_CATS]}
  };
}
let DB=loadDB();
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); renderAll(); }

/* ================== Navigation ================== */
document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  document.querySelectorAll('main section').forEach(s=>s.hidden=true);
  document.getElementById(t.dataset.tab).hidden=false;
}));

/* ================== Logo ================== */
function defaultLogoDataUrl(){
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'>
    <rect rx='16' width='128' height='128' fill='#333'/>
    <text x='50%' y='54%' text-anchor='middle' font-family='Inter,Arial' font-weight='800' font-size='40' fill='#fff'>PTV</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
}
function loadLogo(){
  const data=localStorage.getItem(LOGO_KEY) || defaultLogoDataUrl();
  document.getElementById('logoImg').src=data;
  document.getElementById('logoPreview').src=data;
}
function setLogoFromFile(file){
  const r=new FileReader();
  r.onload=()=>{ localStorage.setItem(LOGO_KEY, r.result); loadLogo(); toast('Logo enregistr√© üëç'); };
  r.readAsDataURL(file);
}
document.getElementById('logoFile').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(f) setLogoFromFile(f);
});
document.getElementById('btnSaveLogo').addEventListener('click',()=>{
  const f=document.getElementById('logoFile').files?.[0]; if(!f) return toast('Choisis une image'); setLogoFromFile(f);
});
document.getElementById('btnClearLogo').addEventListener('click',()=>{ localStorage.removeItem(LOGO_KEY); loadLogo(); toast('Logo supprim√© (logo par d√©faut r√©tabli).'); });

/* ================== Anniversaire J-30 ================== */
function nextBirthdayInfo(ts){
  if(!ts) return {within:false,days:null};
  const d=new Date(ts), today=new Date(), y=today.getFullYear();
  const t0=new Date(y,today.getMonth(),today.getDate());
  let next=new Date(y,d.getMonth(),d.getDate());
  if(next < t0) next=new Date(y+1,d.getMonth(),d.getDate());
  const dd=Math.round((next-t0)/days(1));
  return {within: dd>=0 && dd<=30, days: dd};
}

/* ================== Clients ================== */
const petsContainer=document.getElementById('petsContainer');
function petCard(p={}){
  const card=el('div',{class:'card',style:'padding:10px'});
  const grid=el('div',{class:'grid cols-3'});
  const esp=el('select',{class:'pet-espece'}); ["Chien","Chat"].forEach(v=>esp.append(el('option',{value:v},[v]))); esp.value=p.espece||"Chien";
  const race=el('select',{class:'pet-race'});
  function fillRace(){
    const list=(esp.value==='Chien'?DB.lists.breedsDog:DB.lists.breedsCat)||[];
    race.innerHTML=''; list.forEach(r=>race.append(el('option',{value:r},[r])));
    if(p.race && list.includes(p.race)) race.value=p.race;
  }
  fillRace(); esp.addEventListener('change',fillRace);
  const name=el('input',{class:'pet-name',placeholder:'Nom',value:p.name||''});
  const dob=el('input',{class:'pet-dob',type:'date',value: p.dob? new Date(p.dob).toISOString().slice(0,10):''});
  grid.append(el('div',{},[el('label',{},['Esp√®ce']),esp]));
  grid.append(el('div',{},[el('label',{},['Race']),race]));
  grid.append(el('div',{},[el('label',{},['Nom']),name]));
  grid.append(el('div',{},[el('label',{},['Naissance']),dob]));
  const del=el('button',{class:'ghost',style:'margin-top:8px'},['Supprimer cet animal']);
  del.onclick=()=>{ if(confirm('Supprimer cet animal ?')) card.remove(); };
  card.append(grid,del);
  return card;
}
document.getElementById('btnAddPet').onclick=()=>{ petsContainer.appendChild(petCard()); };

let editingClientId=null;
function clearClientForm(){ ['c_nom','c_tel','c_email','c_addr'].forEach(id=>document.getElementById(id).value=''); petsContainer.innerHTML=''; editingClientId=null; document.getElementById('btnDeleteClient').disabled=true; document.getElementById('cliStats').textContent='S√©lectionnez un client‚Ä¶'; }
document.getElementById('btnNewClient').onclick=clearClientForm;

function readPetsFromUI(){
  return [...petsContainer.querySelectorAll('.card')].map(c=>({
    espece:c.querySelector('.pet-espece').value,
    race:c.querySelector('.pet-race').value,
    name:c.querySelector('.pet-name').value.trim(),
    dob:c.querySelector('.pet-dob').value? new Date(c.querySelector('.pet-dob').value).getTime():null
  }));
}
function fillPetsUI(arr=[]){ petsContainer.innerHTML=''; (arr.length?arr:[{}]).forEach(p=>petsContainer.appendChild(petCard(p))); }
function fillClientForm(c){ editingClientId=c.id; document.getElementById('c_nom').value=c.nom||''; document.getElementById('c_tel').value=c.tel||''; document.getElementById('c_email').value=c.email||''; document.getElementById('c_addr').value=c.addr||''; fillPetsUI(c.animaux||[{}]); document.getElementById('btnDeleteClient').disabled=false; renderClientStats(c.id); }

document.getElementById('btnSaveClient').onclick=()=>{
  const id=editingClientId||Date.now();
  const tel=(document.getElementById('c_tel').value||'').trim();
  if(tel && !/^0\d{8,9}$/.test(tel)) return toast('T√©l√©phone BE invalide : 0 + 9‚Äì10 chiffres (ou laisser vide).');
  const cli={ id,
    nom:(document.getElementById('c_nom').value||'').trim(),
    tel, email:(document.getElementById('c_email').value||'').trim(),
    addr:(document.getElementById('c_addr').value||'').trim(),
    animaux:readPetsFromUI()
  };
  const idx=DB.clients.findIndex(x=>x.id===id); if(idx>=0) DB.clients[idx]=cli; else DB.clients.push(cli);
  saveDB(); clearClientForm();
};
document.getElementById('btnDeleteClient').onclick=()=>{
  if(!editingClientId) return;
  if(!confirm('Supprimer ce client et ses ventes ?')) return;
  DB.clients=DB.clients.filter(c=>c.id!==editingClientId);
  DB.ventes=DB.ventes.filter(v=>v.clientId!==editingClientId);
  saveDB(); clearClientForm();
};

function renderClients(){
  const q=(document.getElementById('searchClient').value||'').toLowerCase();
  const tb=document.querySelector('#tblClients tbody'); tb.innerHTML='';
  DB.clients.filter(c=>{
    const hay=((c.nom||'')+' '+(c.email||'')+' '+(c.tel||'')+' '+(c.animaux||[]).map(a=>(a.name||'')+' '+(a.race||'')).join(' ')).toLowerCase();
    return hay.includes(q);
  }).forEach(c=>{
    const animals=(c.animaux||[]).map(a=>{
      const i=nextBirthdayInfo(a.dob);
      return i.within ? `<span class="gift"><i class="icon"></i><span>${a.name||'‚Äî'}</span></span>` : (a.name||'‚Äî');
    }).join(', ');
    const tr=el('tr'); tr.innerHTML=`<td>${c.nom||'‚Äî'}</td><td>${animals||'‚Äî'}</td><td>${c.tel||'‚Äî'}</td><td>${c.email||'‚Äî'}</td>`;
    tr.onclick=()=>fillClientForm(c); tb.appendChild(tr);
  });

  // Ventes: clients
  const sel=document.getElementById('v_client'); sel.innerHTML=''; sel.appendChild(el('option',{value:''},['‚Äî (aucun) ‚Äî'])); DB.clients.forEach(c=> sel.appendChild(el('option',{value:c.id},[c.nom||('Client '+c.id)])));
}

function renderClientStats(clientId){
  const c=DB.clients.find(x=>x.id===clientId); if(!c){document.getElementById('cliStats').textContent='S√©lectionnez un client‚Ä¶'; return;}
  const t90=Date.now()-days(90);
  const ventes90=DB.ventes.filter(v=>v.clientId===clientId && v.date>=t90).length;
  const soon=(c.animaux||[]).map(a=>{const i=nextBirthdayInfo(a.dob); if(i.within) return `${a.name}: dans ${i.days} j`;}).filter(Boolean).join(' ‚Ä¢ ') || '‚Äî';
  document.getElementById('cliStats').innerHTML=`
    <div class="grid cols-3">
      <div class="card"><h3>Achats (90j)</h3><div style="font-size:22px;font-weight:800">${ventes90}</div></div>
      <div class="card"><h3>Animaux</h3><div style="font-size:22px;font-weight:800">${(c.animaux||[]).length}</div></div>
      <div class="card"><h3>Anniv. √† venir</h3><div>${soon}</div></div>
    </div>`;
}

/* ================== Produits ================== */
let editingProductId=null;
function clearProductForm(){ document.getElementById('p_id').value=''; document.getElementById('p_nom').value=''; document.getElementById('p_stock').value=0; document.getElementById('p_min').value=0; editingProductId=null; document.getElementById('btnDeleteProduct').disabled=true; }
document.getElementById('btnNewProduct').onclick=clearProductForm;

document.getElementById('btnSaveProduct').onclick=()=>{
  const id=document.getElementById('p_id').value || (Date.now()|0);
  const nom=(document.getElementById('p_nom').value||'').trim();
  if(!nom) return toast('Nom du produit requis.');
  const p={id, nom, stock:+(document.getElementById('p_stock').value||0), min:+(document.getElementById('p_min').value||0)};
  const i=DB.produits.findIndex(x=>x.id==id); if(i>=0) DB.produits[i]=p; else DB.produits.push(p);
  DB.produits.sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}));
  saveDB(); clearProductForm();
};
document.getElementById('btnDeleteProduct').onclick=()=>{
  if(!editingProductId) return;
  const used=DB.ventes.some(v=>(v.lignes||[]).some(L=>L.productId==editingProductId));
  if(used){ toast('Ce produit a d√©j√† √©t√© vendu. Suppression interdite (pas d‚Äôarchivage).'); return; }
  if(!confirm('Supprimer d√©finitivement ce produit ?')) return;
  DB.produits=DB.produits.filter(p=>p.id!=editingProductId); saveDB(); clearProductForm();
};
function fillProductForm(p){ editingProductId=p.id; document.getElementById('btnDeleteProduct').disabled=false; document.getElementById('p_id').value=p.id; document.getElementById('p_nom').value=p.nom||''; document.getElementById('p_stock').value=p.stock||0; document.getElementById('p_min').value=p.min||0; }

let alphaFilter='';
function renderAlphaChips(){
  const cont=document.getElementById('alphaChips'); cont.innerHTML='';
  const letters='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
  const all=el('div',{class:'chip'+(alphaFilter===''?' active':'')},['Tous']); all.onclick=()=>{alphaFilter='';renderProduits();}; cont.appendChild(all);
  letters.forEach(ch=>{ const b=el('div',{class:'chip'+(alphaFilter===ch?' active':'')},[ch]); b.onclick=()=>{alphaFilter=(alphaFilter===ch?'':ch); renderProduits();}; cont.appendChild(b); });
}
function produitMatchesAlpha(nom){
  if(!alphaFilter) return true;
  const c=(nom||'').trim().charAt(0).toUpperCase();
  if('0123456789'.includes(alphaFilter)) return '0123456789'.includes(c);
  return c===alphaFilter;
}
function renderProduits(){
  renderAlphaChips();
  const q=(document.getElementById('searchProduit').value||'').toLowerCase();
  const tb=document.querySelector('#tblProduits tbody'); tb.innerHTML='';
  DB.produits.filter(p=> produitMatchesAlpha(p.nom)).filter(p=> (p.nom||'').toLowerCase().includes(q))
    .sort((a,b)=>a.nom.localeCompare(b.nom,'fr',{sensitivity:'base'}))
    .forEach(p=>{
      const low=(p.stock||0)<(p.min||0);
      const statut=low?'<span class="stock-low">Stock bas</span>':'OK';
      const tr=el('tr'); tr.innerHTML=`<td>${p.nom}</td><td>${p.stock||0}</td><td>${p.min||0}</td><td>${statut}</td>`;
      tr.onclick=()=>fillProductForm(p); tb.appendChild(tr);
    });

  // Ventes: produits
  const sel=document.getElementById('v_prod'); sel.innerHTML='';
  DB.produits.forEach(p=> sel.appendChild(el('option',{value:p.id},[p.nom])) );
}
document.getElementById('searchProduit').oninput=renderProduits;

/* ================== Ventes ================== */
document.getElementById('v_client').addEventListener('change',()=>{
  const id=+document.getElementById('v_client').value||0;
  const wrap=document.getElementById('v_client_info');
  if(!id){ wrap.style.display='none'; return; }
  const c=DB.clients.find(x=>x.id===id);
  const list=(c?.animaux||[]).map(a=>{ const info=nextBirthdayInfo(a.dob); return info.within ? `<span class="gift"><i class="icon"></i><span>${a.name}</span></span>` : a.name; }).join(', ');
  document.getElementById('v_client_animals').innerHTML=list||'‚Äî'; wrap.style.display='flex';
});
document.getElementById('btnSaveSale').onclick=()=>{
  const pid=+document.getElementById('v_prod').value; const qty=+document.getElementById('v_qty').value||1;
  if(!pid) return toast('Choisissez un produit');
  const p=DB.produits.find(x=>x.id==pid); if(!p) return toast('Produit introuvable');
  p.stock=(p.stock||0)-qty;
  const cid=+document.getElementById('v_client').value||null;
  DB.ventes.push({id:Date.now(), date:Date.now(), clientId: cid||undefined, lignes:[{productId:pid, qty}]});
  saveDB(); toast('Vente enregistr√©e (stock mis √† jour).'); document.getElementById('v_qty').value=1;
};
document.getElementById('btnCancelSale').onclick=()=>{ document.getElementById('v_qty').value=1; };

/* ================== Param√®tres : Races (A‚ÜíZ) ================== */
function renderBreedEditor(key, containerId){
  const cont=document.getElementById(containerId); cont.innerHTML='';
  const arr=[...(DB.lists[key]||[])].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})); DB.lists[key]=arr;
  arr.forEach((val,idx)=>{
    const chip=el('div',{class:'chip'},[val]); chip.title='Cliquer pour renommer';
    chip.onclick=()=>{ const nv=prompt('Renommer :', val); if(nv==null) return; const t=(nv||'').trim(); if(!t) return; DB.lists[key][idx]=t; DB.lists[key].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})); saveDB(); renderBreedEditor(key,containerId); refreshAllPetRaceSelects(); };
    const del=el('span',{style:'margin-left:6px;cursor:pointer;color:var(--danger)'},['√ó']);
    del.onclick=(e)=>{ e.stopPropagation(); if(confirm('Supprimer ?')){ DB.lists[key].splice(idx,1); saveDB(); renderBreedEditor(key,containerId); refreshAllPetRaceSelects(); } };
    chip.appendChild(del); cont.appendChild(chip);
  });
}
document.querySelectorAll('button[data-add]').forEach(b=>{
  b.addEventListener('click',()=>{
    const key=b.getAttribute('data-add'); const v=prompt('Nouvelle race :'); if(v==null) return;
    DB.lists[key].push((v||'').trim()); DB.lists[key]=DB.lists[key].filter(Boolean).sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})); saveDB(); renderBreedEditor(key,key==='breedsDog'?'editBreedsDog':'editBreedsCat'); refreshAllPetRaceSelects();
  });
});
function refreshAllPetRaceSelects(){
  document.querySelectorAll('.pet-espece').forEach(sel=>{
    const race=sel.closest('.card').querySelector('.pet-race'); const list=(sel.value==='Chien'?DB.lists.breedsDog:DB.lists.breedsCat)||[]; const cur=race.value;
    race.innerHTML=''; list.forEach(r=>race.append(el('option',{value:r},[r]))); if(list.includes(cur)) race.value=cur;
  });
}

/* ================== Export / Import FICHIER .txt ================== */
function download(filename,content){ const blob=new Blob([content],{type:'text/plain;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }
document.getElementById('btnExportTxt').addEventListener('click',()=>{
  const data=JSON.stringify(DB,null,2);
  const dt=new Date(); const stamp=`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
  download(`ptv_sauvegarde_${stamp}.txt`, data);
  toast('Fichier .txt t√©l√©charg√© ‚úÖ');
});
document.getElementById('fileImport').addEventListener('change',e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{ try{ DB=JSON.parse(String(r.result)); saveDB(); toast('Import .txt r√©ussi ‚úÖ'); e.target.value=''; } catch(err){ toast('Fichier invalide (JSON requis √† l‚Äôint√©rieur du .txt)'); } };
  r.readAsText(f,'utf-8');
});
document.getElementById('btnExportJSON').addEventListener('click',()=>{ document.getElementById('exportArea').textContent=JSON.stringify(DB,null,2); });

/* ================== Dashboard ================== */
function renderDashboard(){
  const t30=Date.now()-days(30), t90=Date.now()-days(90);
  // Clients actifs
  const actifs=new Set(DB.ventes.filter(v=>v.date>=t90 && !!v.clientId).map(v=>v.clientId)).size; document.getElementById('kpiActifs').textContent=actifs;

  // Top produits
  const byProd={}; DB.ventes.filter(v=>v.date>=t30).forEach(v=>v.lignes.forEach(L=>{ const p=DB.produits.find(x=>x.id==L.productId); const name=p?p.nom:('Produit '+L.productId); byProd[name]=(byProd[name]||0)+(L.qty||0);})); const tp=Object.entries(byProd).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const tbp=document.querySelector('#tblTopProd tbody'); tbp.innerHTML=''; tp.forEach(([n,q])=>{ const tr=el('tr'); tr.innerHTML=`<td>${n}</td><td>${q}</td>`; tbp.appendChild(tr); }); document.getElementById('kpiTopProd').textContent=tp.length?`${tp[0][0]} (${tp[0][1]})`:'‚Äî';

  // Top clients
  const byCli={}; DB.ventes.filter(v=>v.date>=t30 && !!v.clientId).forEach(v=>{ const c=DB.clients.find(x=>x.id===v.clientId); const name=c?(c.nom||('#'+v.clientId)):'#'+v.clientId; byCli[name]=(byCli[name]||0)+1; }); const tc=Object.entries(byCli).sort((a,b)=>b[1]-a[1]).slice(0,10);
  const tbc=document.querySelector('#tblTopCli tbody'); tbc.innerHTML=''; tc.forEach(([n,k])=>{ const tr=el('tr'); tr.innerHTML=`<td>${n}</td><td>${k}</td>`; tbc.appendChild(tr); }); document.getElementById('kpiTopCli').textContent=tc.length?`${tc[0][0]} (${tc[0][1]})`:'‚Äî';

  // Anniversaires (30j)
  const soon=[]; DB.clients.forEach(c=> (c.animaux||[]).forEach(a=>{ const i=nextBirthdayInfo(a.dob); if(i.within) soon.push({client:c.nom||'‚Äî', animal:a.name||'‚Äî', days:i.days}); }));
  soon.sort((a,b)=>a.days-b.days || a.animal.localeCompare(b.animal,'fr'));
  const tbb=document.querySelector('#tblBirthSoon tbody'); tbb.innerHTML=''; soon.forEach(x=>{ const tr=el('tr'); tr.innerHTML=`<td>${x.client}</td><td><span class="gift"><i class="icon"></i><span>${x.animal}</span></span></td><td>${x.days}</td>`; tbb.appendChild(tr); });
}

/* ================== Global render ================== */
document.getElementById('searchClient').oninput=renderClients;
function renderAll(){
  // Clients
  renderClients();
  // Produits
  renderProduits();
  // Races
  renderBreedEditor('breedsDog','editBreedsDog'); renderBreedEditor('breedsCat','editBreedsCat');
  // Ventes lists
  const vprod=document.getElementById('v_prod'); vprod.innerHTML=''; DB.produits.forEach(p=> vprod.appendChild(el('option',{value:p.id},[p.nom])));
  const vcli=document.getElementById('v_client'); vcli.innerHTML=''; vcli.appendChild(el('option',{value:''},['‚Äî (aucun) ‚Äî'])); DB.clients.forEach(c=> vcli.appendChild(el('option',{value:c.id},[c.nom||('Client '+c.id)])));
  // Dashboard
  renderDashboard();
  // Logo preview
  loadLogo();
}
document.addEventListener("DOMContentLoaded",()=>{
  renderChangelog();
  renderAll();
  showVersionPopup(); // alerte si version nouvelle
});
</script>
</body>
</html>